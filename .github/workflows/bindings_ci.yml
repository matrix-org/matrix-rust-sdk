name: Bindings tests

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

env:
  CARGO_TERM_COLOR: always
  MATRIX_SDK_CRYPTO_NODEJS_PATH: bindings/matrix-sdk-crypto-nodejs

jobs:
  test-matrix-sdk-crypto-nodejs:
    name: ${{ matrix.os-name }} [m]-crypto-nodejs, v${{ matrix.node-version }}
    if: github.event_name == 'push' || !github.event.pull_request.draft

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest]
        node-version: [18.0]
        include:
          - os: ubuntu-latest
            os-name: üêß

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v2

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Load cache
        uses: Swatinem/rust-cache@v1

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install NPM dependencies
        working-directory: ${{ env.MATRIX_SDK_CRYPTO_NODEJS_PATH }}
        run: npm install

      - name: Build the Node.js binding
        working-directory: ${{ env.MATRIX_SDK_CRYPTO_NODEJS_PATH }}
        run: npm run build

      - name: Test the Node.js binding
        working-directory: ${{ env.MATRIX_SDK_CRYPTO_NODEJS_PATH }}
        run: |
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test
          npm run test

      - if: ${{ matrix.build-doc }}
        name: Build the documentation
        working-directory: ${{ env.MATRIX_SDK_CRYPTO_NODEJS_PATH }}
        run: npm run doc

      - if: ${{ failure() }}
        name: Setup tmate session
        uses: mxschmitt/action-tmate@v3

      - if: ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          path: bindings/matrix-sdk-crypto-nodejs/matrix-sdk-crypto.*.node
          if-no-files-found: error
